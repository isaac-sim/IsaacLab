# Copyright (c) 2022-2025, The Isaac Lab Project Developers (https://github.com/isaac-sim/IsaacLab/blob/main/CONTRIBUTORS.md).
# All rights reserved.
#
# SPDX-License-Identifier: BSD-3-Clause
from __future__ import annotations

import logging
import warnings
import weakref

import warp as wp
from isaaclab_newton.kernels import (
    combine_frame_transforms_partial_batch,
    combine_frame_transforms_partial_root,
    combine_pose_and_velocity_to_state,
    combine_pose_and_velocity_to_state_batched,
    compute_heading,
    derive_body_acceleration_from_velocity_batched,
    generate_pose_from_position_with_unit_quaternion_batched,
    project_com_velocity_to_link_frame_batch,
    project_com_velocity_to_link_frame_root,
    project_vec_from_pose_single,
    project_velocities_to_frame,
    split_spatial_vectory_array_to_angular_velocity_array,
    split_spatial_vectory_array_to_linear_velocity_array,
    split_spatial_vectory_batched_array_to_angular_velocity_batched_array,
    split_spatial_vectory_batched_array_to_linear_velocity_batched_array,
    split_transform_array_to_position_array,
    split_transform_array_to_quaternion_array,
    split_transform_batched_array_to_position_batched_array,
    split_transform_batched_array_to_quaternion_batched_array,
    vec13f,
)
from newton.selection import ArticulationView as NewtonArticulationView

from isaaclab.assets.rigid_object.base_rigid_object_data import BaseRigidObjectData
from isaaclab.sim._impl.newton_manager import NewtonManager
from isaaclab.utils.buffers import TimestampedWarpBuffer
from isaaclab.utils.helpers import deprecated, warn_overhead_cost

logger = logging.getLogger(__name__)
warnings.simplefilter("once", UserWarning)
logging.captureWarnings(True)


class RigidObjectData(BaseRigidObjectData):
    """Data container for a rigid object.

    This class contains the data for a rigid object in the simulation. The data includes the state of
    the root rigid body and the state of all the bodies in the object. The data is stored in the simulation
    world frame unless otherwise specified.

    For a rigid body, there are two frames of reference that are used:

    - Actor frame: The frame of reference of the rigid body prim. This typically corresponds to the Xform prim
      with the rigid body schema.
    - Center of mass frame: The frame of reference of the center of mass of the rigid body.

    Depending on the settings of the simulation, the actor frame and the center of mass frame may be the same.
    This needs to be taken into account when interpreting the data.

    The data is lazily updated, meaning that the data is only updated when it is accessed. This is useful
    when the data is expensive to compute or retrieve. The data is updated when the timestamp of the buffer
    is older than the current simulation timestamp. The timestamp is updated whenever the data is updated.
    """

    def __init__(self, root_view, device: str):
        """Initializes the rigid object data.

        Args:
            root_physx_view: The root rigid body view.
            device: The device used for processing.
        """
        # Set the parameters
        self.device = device
        # Set the root articulation view
        # note: this is stored as a weak reference to avoid circular references between the asset class
        #  and the data container. This is important to avoid memory leaks.
        self._root_view: NewtonArticulationView = weakref.proxy(root_view)

        # Set initial time stamp
        self._sim_timestamp = 0.0
        # obtain global simulation view
        gravity = wp.to_torch(NewtonManager.get_model().gravity)[0]
        gravity_dir = [float(i) / sum(gravity) for i in gravity]
        # Initialize constants
        self.GRAVITY_VEC_W = wp.vec3f(gravity_dir[0], gravity_dir[1], gravity_dir[2])
        self.FORWARD_VEC_B = wp.vec3f((1.0, 0.0, 0.0))
        # Create the simulation bindings and buffers
        self._create_simulation_bindings()
        self._create_buffers()

    ##
    # Names.
    ##

    body_names: list[str] = None
    """Body names in the order parsed by the simulation view."""

    ##
    # Defaults.
    ##

    @property
    def default_root_pose(self) -> wp.array(dtype=wp.transformf):
        """Default root pose ``[pos, quat]`` in the local environment frame. Shape is (num_instances, 7).

        The position and quaternion are of the rigid body's actor frame.
        """
        return self._default_root_pose

    @property
    def default_root_vel(self) -> wp.array(dtype=wp.spatial_vectorf):
        """Default root velocity ``[lin_vel, ang_vel]`` in the local environment frame. Shape is (num_instances, 6).

        The linear and angular velocities are of the rigid body's center of mass frame.
        """
        return self._default_root_vel

    ##
    # Root state properties.
    ##

    @property
    def root_link_pose_w(self) -> wp.array(dtype=wp.transformf):
        """Root link pose ``[pos, quat]`` in simulation world frame. Shape is (num_instances, 7).

        This quantity is the pose of the actor frame of the root rigid body relative to the world.
        The orientation is provided in (x, y, z, w) format.
        """
        return self._sim_bind_root_link_pose_w

    @property
    def root_link_vel_w(self) -> wp.array(dtype=wp.spatial_vectorf):
        """Root link velocity ``[lin_vel, ang_vel]`` in simulation world frame. Shape is (num_instances, 6).

        This quantity contains the linear and angular velocities of the actor frame of the root
        rigid body relative to the world.
        """
        if self._root_link_vel_w.timestamp < self._sim_timestamp:
            wp.launch(
                project_com_velocity_to_link_frame_root,
                dim=(self._root_view.count),
                device=self.device,
                inputs=[
                    self._sim_bind_root_com_vel_w,
                    self._sim_bind_root_link_pose_w,
                    self._sim_bind_body_com_pos_b,
                    self._root_link_vel_w.data,
                ],
            )
            # set the buffer data and timestamp
            self._root_link_vel_w.timestamp = self._sim_timestamp

        return self._root_link_vel_w.data

    @property
    def root_com_pose_w(self) -> wp.array(dtype=wp.transformf):
        """Root center of mass pose ``[pos, quat]`` in simulation world frame. Shape is (num_instances, 7).

        This quantity is the pose of the center of mass frame of the root rigid body relative to the world.
        The orientation is provided in (x, y, z, w) format.
        """
        if self._root_com_pose_w.timestamp < self._sim_timestamp:
            # apply local transform to center of mass frame
            wp.launch(
                combine_frame_transforms_partial_root,
                dim=(self._root_view.count),
                device=self.device,
                inputs=[
                    self._sim_bind_root_link_pose_w,
                    self._sim_bind_body_com_pos_b,
                    self._root_com_pose_w.data,
                ],
            )
            # set the buffer data and timestamp
            self._root_com_pose_w.timestamp = self._sim_timestamp

        return self._root_com_pose_w.data

    @property
    def root_com_vel_w(self) -> wp.array(dtype=wp.spatial_vectorf):
        """Root center of mass velocity ``[lin_vel, ang_vel]`` in simulation world frame. Shape is (num_instances, 6).

        This quantity contains the linear and angular velocities of the root rigid body's center of mass frame
        relative to the world.
        """
        return self._sim_bind_root_com_vel_w

    @property
    @warn_overhead_cost(
        "root_link_pose_w or root_com_vel_w",
        "Launches a kernel to merge a pose and a velocity into a state. Consider using the pose and velocity arrays"
        " directly instead.",
    )
    @deprecated("root_link_pose_w or root_com_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_state_w(self) -> wp.array(dtype=vec13f):
        """Root state ``[pos, quat, lin_vel, ang_vel]`` in simulation world frame. Shape is (num_instances, 13).

        The position and orientation are of the rigid body's actor frame. Meanwhile, the linear and angular
        velocities are of the rigid body's center of mass frame.
        """
        state = wp.zeros((self._root_view.count), dtype=vec13f, device=self.device)
        wp.launch(
            combine_pose_and_velocity_to_state,
            dim=(self._root_view.count,),
            device=self.device,
            inputs=[
                self._sim_bind_root_link_pose_w,
                self._sim_bind_root_com_vel_w,
                state,
            ],
        )
        return state

    @property
    @warn_overhead_cost(
        "root_link_pose_w or root_link_vel_w",
        "Launches a kernel to merge a pose and a velocity into a state. Consider using the pose and velocity arrays"
        " directly instead.",
    )
    @deprecated("root_link_pose_w or root_link_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_link_state_w(self) -> wp.array(dtype=vec13f):
        """Root state ``[pos, quat, lin_vel, ang_vel]`` in simulation world frame. Shape is (num_instances, 13).

        The position, quaternion, and linear/angular velocity are of the rigid body root frame relative to the
        world. The orientation is provided in (x, y, z, w) format.
        """
        state = wp.zeros((self._root_view.count), dtype=vec13f, device=self.device)
        wp.launch(
            combine_pose_and_velocity_to_state,
            dim=(self._root_view.count,),
            device=self.device,
            inputs=[
                self._sim_bind_root_link_pose_w,
                self.root_link_vel_w,
                state,
            ],
        )
        return state

    @property
    @warn_overhead_cost(
        "root_com_pose_w or root_com_vel_w",
        "Launches a kernel to merge a pose and a velocity into a state. Consider using the pose and velocity arrays"
        " directly instead.",
    )
    @deprecated("root_com_pose_w or root_com_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_com_state_w(self) -> wp.array(dtype=vec13f):
        """Root center of mass state ``[pos, quat, lin_vel, ang_vel]`` in simulation world frame.
        Shape is (num_instances, 13).

        The position, quaternion, and linear/angular velocity are of the rigid body's center of mass frame
        relative to the world. Center of mass frame is the orientation principle axes of inertia.
        """
        state = wp.zeros((self._root_view.count), dtype=vec13f, device=self.device)
        wp.launch(
            combine_pose_and_velocity_to_state,
            dim=(self._root_view.count,),
            device=self.device,
            inputs=[
                self.root_com_pose_w,
                self._sim_bind_root_com_vel_w,
                state,
            ],
        )
        return state

    ##
    # Body state properties.
    ##

    @property
    def body_link_pose_w(self) -> wp.array(dtype=wp.transformf):
        """Body link pose ``[pos, quat]`` in simulation world frame. Shape is (num_instances, 1, 7).

        This quantity is the pose of the actor frame of the rigid body relative to the world.
        The orientation is provided in (x, y, z, w) format.
        """
        return self._sim_bind_body_link_pose_w

    @property
    def body_link_vel_w(self) -> wp.array(dtype=wp.spatial_vectorf):
        """Body link velocity ``[lin_vel, ang_vel]`` in simulation world frame. Shape is (num_instances, 1, 6).

        This quantity contains the linear and angular velocities of the actor frame of the root
        rigid body relative to the world.
        """
        if self._body_link_vel_w.timestamp < self._sim_timestamp:
            # Project the velocity from the center of mass frame to the link frame
            wp.launch(
                project_com_velocity_to_link_frame_batch,
                dim=(self._root_view.count, self._root_view.link_count),
                device=self.device,
                inputs=[
                    self._sim_bind_body_com_vel_w,
                    self._sim_bind_body_link_pose_w,
                    self._sim_bind_body_com_pos_b,
                    self._body_link_vel_w.data,
                ],
            )
            # set the buffer data and timestamp
            self._body_link_vel_w.timestamp = self._sim_timestamp
        return self._body_link_vel_w.data

    @property
    def body_com_pose_w(self) -> wp.array(dtype=wp.transformf):
        """Body center of mass pose ``[pos, quat]`` in simulation world frame. Shape is (num_instances, 1, 7).

        This quantity is the pose of the center of mass frame of the rigid body relative to the world.
        The orientation is provided in (x, y, z, w) format.
        """
        if self._body_com_pose_w.timestamp < self._sim_timestamp:
            # Apply local transform to center of mass frame
            wp.launch(
                combine_frame_transforms_partial_batch,
                dim=(self._root_view.count, self._root_view.link_count),
                device=self.device,
                inputs=[
                    self._sim_bind_body_link_pose_w,
                    self._sim_bind_body_com_pos_b,
                    self._body_com_pose_w.data,
                ],
            )
            # set the buffer data and timestamp
            self._body_com_pose_w.timestamp = self._sim_timestamp
        return self._body_com_pose_w.data

    @property
    def body_com_vel_w(self) -> wp.array(dtype=wp.spatial_vectorf):
        """Body center of mass velocity ``[lin_vel, ang_vel]`` in simulation world frame.
        Shape is (num_instances, 1, 6).

        This quantity contains the linear and angular velocities of the root rigid body's center of mass frame
        relative to the world.
        """
        if self._body_com_pose_w.timestamp < self._sim_timestamp:
            # Apply local transform to center of mass frame
            wp.launch(
                combine_frame_transforms_partial_batch,
                dim=(self._root_view.count, self._root_view.link_count),
                device=self.device,
                inputs=[
                    self._sim_bind_body_link_pose_w,
                    self._sim_bind_body_com_pos_b,
                    self._body_com_pose_w.data,
                ],
            )
            # set the buffer data and timestamp
            self._body_com_pose_w.timestamp = self._sim_timestamp
        return self._body_com_pose_w.data

    @property
    @warn_overhead_cost(
        "body_link_pose_w or body_com_vel_w",
        "Launches a kernel to merge a pose and a velocity into a state. Consider using the pose and velocity arrays"
        " directly instead.",
    )
    @deprecated("body_link_pose_w or body_com_vel_w", since="3.0.0", remove_in="4.0.0")
    def body_state_w(self) -> wp.array(dtype=vec13f):
        """State of all bodies `[pos, quat, lin_vel, ang_vel]` in simulation world frame.
        Shape is (num_instances, 1, 13).

        The position and orientation are of the rigid bodies' actor frame. Meanwhile, the linear and angular
        velocities are of the rigid bodies' center of mass frame.
        """
        state = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=vec13f, device=self.device)
        wp.launch(
            combine_pose_and_velocity_to_state_batched,
            dim=(self._root_view.count, self._root_view.link_count),
            device=self.device,
            inputs=[
                self._sim_bind_body_link_pose_w,
                self._sim_bind_body_com_vel_w,
                state,
            ],
        )
        return state

    @property
    @warn_overhead_cost(
        "body_link_pose_w or body_link_vel_w",
        "Launches a kernel to merge a pose and a velocity into a state. Consider using the pose and velocity arrays"
        " directly instead.",
    )
    @deprecated("body_link_pose_w or body_link_vel_w", since="3.0.0", remove_in="4.0.0")
    def body_link_state_w(self) -> wp.array(dtype=vec13f):
        """State of all bodies ``[pos, quat, lin_vel, ang_vel]`` in simulation world frame.
        Shape is (num_instances, 1, 13).

        The position, quaternion, and linear/angular velocity are of the body's link frame relative to the world.
        The orientation is provided in (x, y, z, w) format.
        """
        state = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=vec13f, device=self.device)
        wp.launch(
            combine_pose_and_velocity_to_state_batched,
            dim=(self._root_view.count, self._root_view.link_count),
            device=self.device,
            inputs=[
                self._sim_bind_body_link_pose_w,
                self.body_link_vel_w,
                state,
            ],
        )
        return state

    @property
    @warn_overhead_cost(
        "body_com_pose_w or body_com_vel_w",
        "Launches a kernel to merge a pose and a velocity into a state. Consider using the pose and velocity arrays"
        " directly instead.",
    )
    @deprecated("body_com_pose_w or body_com_vel_w", since="3.0.0", remove_in="4.0.0")
    def body_com_state_w(self) -> wp.array(dtype=vec13f):
        """State of all bodies ``[pos, quat, lin_vel, ang_vel]`` in simulation world frame.
        Shape is (num_instances, num_bodies, 13).

        The position, quaternion, and linear/angular velocity are of the body's center of mass frame relative to the
        world. Center of mass frame is assumed to be the same orientation as the link rather than the orientation of the
        principle inertia. The orientation is provided in (x, y, z, w) format.
        """
        state = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=vec13f, device=self.device)
        wp.launch(
            combine_pose_and_velocity_to_state_batched,
            dim=(self._root_view.count, self._root_view.link_count),
            device=self.device,
            inputs=[
                self.body_com_pose_w,
                self._sim_bind_body_com_vel_w,
                state,
            ],
        )
        return state

    @property
    def body_com_acc_w(self) -> wp.array(dtype=wp.spatial_vectorf):
        """Acceleration of all bodies ``[lin_acc, ang_acc]`` in the simulation world frame.
        Shape is (num_instances, 1, 6).

        This quantity is the acceleration of the rigid bodies' center of mass frame relative to the world.
        """
        if self._body_com_acc_w.timestamp < self._sim_timestamp:
            wp.launch(
                derive_body_acceleration_from_velocity_batched,
                dim=(self._root_view.count, self._root_view.link_count),
                inputs=[
                    self._sim_bind_body_com_vel_w,
                    self._previous_body_com_vel,
                    NewtonManager.get_dt(),
                    self._body_com_acc_w.data,
                ],
            )
            # set the buffer data and timestamp
            self._body_com_acc_w.timestamp = self._sim_timestamp
        return self._body_com_acc_w.data

    @property
    def body_com_pose_b(self) -> wp.array(dtype=wp.transformf):
        """Center of mass pose ``[pos, quat]`` of all bodies in their respective body's link frames.
        Shape is (num_instances, 1, 7).

        This quantity is the pose of the center of mass frame of the rigid body relative to the body's link frame.
        The orientation is provided in (x, y, z, w) format.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.transformf, device=self.device)
        wp.launch(
            generate_pose_from_position_with_unit_quaternion_batched,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self._sim_bind_body_com_pos_b,
                out,
            ],
        )
        return out

    ##
    # Derived Properties.
    ##

    @property
    def projected_gravity_b(self) -> wp.array(dtype=wp.vec3f):
        """Projection of the gravity direction on base frame. Shape is (num_instances, 3)."""
        if self._projected_gravity_b.timestamp < self._sim_timestamp:
            wp.launch(
                project_vec_from_pose_single,
                dim=self._root_view.count,
                inputs=[
                    self.GRAVITY_VEC_W,
                    self._sim_bind_root_link_pose_w,
                    self._projected_gravity_b.data,
                ],
            )
            # set the buffer data and timestamp
            self._projected_gravity_b.timestamp = self._sim_timestamp
        return self._projected_gravity_b.data

    @property
    def heading_w(self) -> wp.array(dtype=wp.float32):
        """Yaw heading of the base frame (in radians). Shape is (num_instances,).

        Note:
            This quantity is computed by assuming that the forward-direction of the base
            frame is along x-direction, i.e. :math:`(1, 0, 0)`.
        """
        if self._heading_w.timestamp < self._sim_timestamp:
            wp.launch(
                compute_heading,
                dim=self._root_view.count,
                inputs=[
                    self.FORWARD_VEC_B,
                    self._sim_bind_root_link_pose_w,
                    self._heading_w.data,
                ],
            )
            # set the buffer data and timestamp
            self._heading_w.timestamp = self._sim_timestamp
        return self._heading_w.data

    @property
    def root_link_vel_b(self) -> wp.array(dtype=wp.spatial_vectorf):
        """Root link velocity ``wp.spatial_vectorf`` in base frame. Shape is (num_instances).

        Velocity is provided in the form of [vx, vy, vz, wx, wy, wz].
        """
        if self._root_link_vel_b.timestamp < self._sim_timestamp:
            wp.launch(
                project_velocities_to_frame,
                dim=self._root_view.count,
                inputs=[
                    self.root_link_vel_w,
                    self._sim_bind_root_link_pose_w,
                    self._root_link_vel_b.data,
                ],
            )
            # set the buffer data and timestamp
            self._root_link_vel_b.timestamp = self._sim_timestamp
        return self._root_link_vel_b.data

    @property
    def root_com_vel_b(self) -> wp.array(dtype=wp.spatial_vectorf):
        """Root center of mass velocity ``wp.spatial_vectorf`` in base frame. Shape is (num_instances).

        Velocity is provided in the form of [vx, vy, vz, wx, wy, wz].
        """
        if self._root_com_vel_b.timestamp < self._sim_timestamp:
            wp.launch(
                project_velocities_to_frame,
                dim=self._root_view.count,
                inputs=[
                    self._sim_bind_root_com_vel_w,
                    self._sim_bind_root_link_pose_w,
                    self._root_com_vel_b.data,
                ],
            )
            # set the buffer data and timestamp
            self._root_com_vel_b.timestamp = self._sim_timestamp
        return self._root_com_vel_b.data

    @property
    @warn_overhead_cost(
        "root_link_vel_w",
        "Launches a kernel to split the spatial velocity array to a linear velocity array. Consider using the spatial"
        " velocity array directly instead.",
    )
    @deprecated("root_link_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_link_lin_vel_b(self) -> wp.array(dtype=wp.vec3f):
        """Root link linear velocity in base frame. Shape is (num_instances, 3).

        This quantity is the linear velocity of the articulation root's actor frame with respect to the
        its actor frame.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_array_to_linear_velocity_array,
            dim=self._root_view.count,
            inputs=[
                self.root_link_vel_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "root_link_vel_w",
        "Launches a kernel to split the spatial velocity array to an angular velocity array. Consider using the spatial"
        " velocity array directly instead.",
    )
    @deprecated("root_link_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_link_ang_vel_b(self) -> wp.array(dtype=wp.vec3f):
        """Root link angular velocity in base world frame. Shape is (num_instances, 3).

        This quantity is the angular velocity of the articulation root's actor frame with respect to the
        its actor frame.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_array_to_angular_velocity_array,
            dim=self._root_view.count,
            inputs=[
                self.root_link_vel_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "root_com_vel_w",
        "Launches a kernel to split the spatial velocity array to a linear velocity array. Consider using the spatial"
        " velocity array directly instead.",
    )
    @deprecated("root_com_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_com_lin_vel_b(self) -> wp.array(dtype=wp.vec3f):
        """Root center of mass linear velocity in base frame. Shape is (num_instances, 3).

        This quantity is the linear velocity of the articulation root's center of mass frame with respect to the
        its actor frame.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_array_to_linear_velocity_array,
            dim=self._root_view.count,
            inputs=[
                self._sim_bind_root_com_vel_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "root_com_vel_w",
        "Launches a kernel to split the spatial velocity array to an angular velocity array. Consider using the spatial"
        " velocity array directly instead.",
    )
    @deprecated("root_com_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_com_ang_vel_b(self) -> wp.array(dtype=wp.vec3f):
        """Root center of mass angular velocity in base world frame. Shape is (num_instances, 3).

        This quantity is the angular velocity of the articulation root's center of mass frame with respect to the
        its actor frame.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_array_to_angular_velocity_array,
            dim=self._root_view.count,
            inputs=[
                self._sim_bind_root_com_vel_w,
                out,
            ],
        )
        return out

    ##
    # Sliced properties.
    ##

    @property
    @warn_overhead_cost(
        "root_link_pose_w",
        "Launches a kernel to split the transform array to a position array. Consider using the transform array"
        " directly instead.",
    )
    @deprecated("root_link_pose_w", since="3.0.0", remove_in="4.0.0")
    def root_link_pos_w(self) -> wp.array(dtype=wp.vec3f):
        """Root link position in simulation world frame. Shape is (num_instances, 3).

        This quantity is the position of the actor frame of the root rigid body relative to the world.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_transform_array_to_position_array,
            dim=self._root_view.count,
            inputs=[
                self._sim_bind_root_link_pose_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "root_link_pose_w",
        "Launches a kernel to split the transform array to a quaternion array. Consider using the transform array"
        " directly instead.",
    )
    @deprecated("root_link_pose_w", since="3.0.0", remove_in="4.0.0")
    def root_link_quat_w(self) -> wp.array(dtype=wp.quatf):
        """Root link orientation (x, y, z, w) in simulation world frame. Shape is (num_instances, 4).

        This quantity is the orientation of the actor frame of the root rigid body.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.quatf, device=self.device)
        wp.launch(
            split_transform_array_to_quaternion_array,
            dim=self._root_view.count,
            inputs=[
                self._sim_bind_root_link_pose_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "root_link_vel_w",
        "Launches a kernel to split the spatial velocity array to a linear velocity array. Consider using the spatial"
        " velocity array directly instead.",
    )
    @deprecated("root_link_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_link_lin_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Root linear velocity in simulation world frame. Shape is (num_instances, 3).

        This quantity is the linear velocity of the root rigid body's actor frame relative to the world.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.quatf, device=self.device)
        wp.launch(
            split_transform_array_to_quaternion_array,
            dim=self._root_view.count,
            inputs=[
                self._sim_bind_root_link_pose_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "root_link_vel_w",
        "Launches a kernel to split the spatial velocity array to an angular velocity array. Consider using the spatial"
        " velocity array directly instead.",
    )
    @deprecated("root_link_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_link_ang_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Root link angular velocity in simulation world frame. Shape is (num_instances, 3).

        This quantity is the angular velocity of the actor frame of the root rigid body relative to the world.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_array_to_angular_velocity_array,
            dim=self._root_view.count,
            inputs=[
                self.root_link_vel_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "root_com_pose_w",
        "Launches a kernel to split the transform array to a position array. Consider using the transform array"
        " directly instead.",
    )
    @deprecated("root_com_pose_w", since="3.0.0", remove_in="4.0.0")
    def root_com_pos_w(self) -> wp.array(dtype=wp.vec3f):
        """Root center of mass position in simulation world frame. Shape is (num_instances, 3).

        This quantity is the position of the actor frame of the root rigid body relative to the world.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_transform_array_to_position_array,
            dim=self._root_view.count,
            inputs=[
                self.root_com_pose_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "root_com_pose_w",
        "Launches a kernel to split the transform array to a quaternion array. Consider using the transform array"
        " directly instead.",
    )
    @deprecated("root_com_pose_w", since="3.0.0", remove_in="4.0.0")
    def root_com_quat_w(self) -> wp.array(dtype=wp.quatf):
        """Root center of mass orientation (x, y, z, w) in simulation world frame. Shape is (num_instances, 4).

        This quantity is the orientation of the actor frame of the root rigid body relative to the world.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.quatf, device=self.device)
        wp.launch(
            split_transform_array_to_quaternion_array,
            dim=self._root_view.count,
            inputs=[
                self.root_com_pose_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "root_com_vel_w",
        "Launches a kernel to split the spatial velocity array to a linear velocity array. Consider using the spatial"
        " velocity array directly instead.",
    )
    @deprecated("root_com_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_com_lin_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Root center of mass linear velocity in simulation world frame. Shape is (num_instances, 3).

        This quantity is the linear velocity of the root rigid body's center of mass frame relative to the world.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_array_to_linear_velocity_array,
            dim=self._root_view.count,
            inputs=[
                self._sim_bind_root_com_vel_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "root_com_vel_w",
        "Launches a kernel to split the spatial velocity array to an angular velocity array. Consider using the spatial"
        " velocity array directly instead.",
    )
    @deprecated("root_com_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_com_ang_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Root center of mass angular velocity in simulation world frame. Shape is (num_instances, 3).

        This quantity is the angular velocity of the root rigid body's center of mass frame relative to the world.
        """
        out = wp.zeros((self._root_view.count,), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_array_to_angular_velocity_array,
            dim=self._root_view.count,
            inputs=[
                self._sim_bind_root_com_vel_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "body_link_pose_w",
        "Launches a kernel to split the transform array to a position array. Consider using the transform array"
        " directly instead.",
    )
    @deprecated("body_link_pose_w", since="3.0.0", remove_in="4.0.0")
    def body_link_pos_w(self) -> wp.array(dtype=wp.vec3f):
        """Positions of all bodies in simulation world frame. Shape is (num_instances, 1, 3).

        This quantity is the position of the rigid bodies' actor frame relative to the world.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_transform_batched_array_to_position_batched_array,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self._sim_bind_body_link_pose_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "body_link_pose_w",
        "Launches a kernel to split the transform array to a quaternion array. Consider using the transform array"
        " directly instead.",
    )
    @deprecated("body_link_pose_w", since="3.0.0", remove_in="4.0.0")
    def body_link_quat_w(self) -> wp.array(dtype=wp.quatf):
        """Orientation (x, y, z, w) of all bodies in simulation world frame. Shape is (num_instances, 1, 4).

        This quantity is the orientation of the rigid bodies' actor frame  relative to the world.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.quatf, device=self.device)
        wp.launch(
            split_transform_batched_array_to_quaternion_batched_array,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self._sim_bind_body_link_pose_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "body_link_vel_w",
        "Launches a kernel to split the velocity array to a linear velocity array. Consider using the velocity array"
        " directly instead.",
    )
    @deprecated("body_link_vel_w", since="3.0.0", remove_in="4.0.0")
    def body_link_lin_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Linear velocity of all bodies in simulation world frame. Shape is (num_instances, 1, 3).

        This quantity is the linear velocity of the rigid bodies' center of mass frame relative to the world.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_batched_array_to_linear_velocity_batched_array,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self.body_link_vel_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "body_link_vel_w",
        "Launches a kernel to split the velocity array to an angular velocity array. Consider using the velocity array"
        " directly instead.",
    )
    @deprecated("body_link_vel_w", since="3.0.0", remove_in="4.0.0")
    def body_link_ang_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Angular velocity of all bodies in simulation world frame. Shape is (num_instances, 1, 3).

        This quantity is the angular velocity of the rigid bodies' center of mass frame relative to the world.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_batched_array_to_angular_velocity_batched_array,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self.body_link_vel_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "body_com_pose_w",
        "Launches a kernel to split the transform array to a position array. Consider using the transform array"
        " directly instead.",
    )
    @deprecated("body_com_pose_w", since="3.0.0", remove_in="4.0.0")
    def body_com_pos_w(self) -> wp.array(dtype=wp.vec3f):
        """Positions of all bodies in simulation world frame. Shape is (num_instances, 1, 3).

        This quantity is the position of the rigid bodies' actor frame.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_transform_batched_array_to_position_batched_array,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self.body_com_pose_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "body_com_pose_w",
        "Launches a kernel to split the transform array to a quaternion array. Consider using the transform array"
        " directly instead.",
    )
    @deprecated("body_com_pose_w", since="3.0.0", remove_in="4.0.0")
    def body_com_quat_w(self) -> wp.array(dtype=wp.quatf):
        """Orientation (x, y, z, w) of the principle axis of inertia of all bodies in simulation world frame.

        Shape is (num_instances, 1, 4). This quantity is the orientation of the rigid bodies' actor frame.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.quatf, device=self.device)
        wp.launch(
            split_transform_batched_array_to_quaternion_batched_array,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self.body_com_pose_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "body_com_vel_w",
        "Launches a kernel to split the velocity array to a linear velocity array. Consider using the velocity array"
        " directly instead.",
    )
    @deprecated("body_com_vel_w", since="3.0.0", remove_in="4.0.0")
    def body_com_lin_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Linear velocity of all bodies in simulation world frame. Shape is (num_instances, 1, 3).

        This quantity is the linear velocity of the rigid bodies' center of mass frame.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_batched_array_to_linear_velocity_batched_array,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self._sim_bind_body_com_vel_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "body_com_vel_w",
        "Launches a kernel to split the velocity array to an angular velocity array. Consider using the velocity array"
        " directly instead.",
    )
    @deprecated("body_com_vel_w", since="3.0.0", remove_in="4.0.0")
    def body_com_ang_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Angular velocity of all bodies in simulation world frame. Shape is (num_instances, 1, 3).

        This quantity is the angular velocity of the rigid bodies' center of mass frame.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_batched_array_to_angular_velocity_batched_array,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self._sim_bind_body_com_vel_w,
                out,
            ],
        )
        return out

    @property
    def body_com_lin_acc_w(self) -> wp.array(dtype=wp.vec3f):
        """Linear acceleration of all bodies in simulation world frame. Shape is (num_instances, 1, 3).

        This quantity is the linear acceleration of the rigid bodies' center of mass frame.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_batched_array_to_linear_velocity_batched_array,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self.body_com_acc_w,
                out,
            ],
        )
        return out

    @property
    @warn_overhead_cost(
        "body_com_acc_w",
        "Launches a kernel to split the velocity array to an angular velocity array. Consider using the velocity array"
        " directly instead.",
    )
    @deprecated("body_com_acc_w", since="3.0.0", remove_in="4.0.0")
    def body_com_ang_acc_w(self) -> wp.array(dtype=wp.vec3f):
        """Angular acceleration of all bodies in simulation world frame. Shape is (num_instances, 1, 3).

        This quantity is the angular acceleration of the rigid bodies' center of mass frame.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.vec3f, device=self.device)
        wp.launch(
            split_spatial_vectory_batched_array_to_angular_velocity_batched_array,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self.body_com_acc_w,
                out,
            ],
        )
        return out

    @property
    def body_com_pos_b(self) -> wp.array(dtype=wp.vec3f):
        """Center of mass position of all of the bodies in their respective link frames.
        Shape is (num_instances, 1, 3).

        This quantity is the center of mass location relative to its body'slink frame.
        """
        return self._sim_bind_body_com_pos_b

    @property
    @warn_overhead_cost(
        "unit_quaternion",
        "Launches a kernel to split the pose array to a quaternion array. Consider using the pose array directly"
        " instead.",
    )
    @deprecated("unit_quaternion", since="3.0.0", remove_in="4.0.0")
    def body_com_quat_b(self) -> wp.array(dtype=wp.quatf):
        """Orientation (x, y, z, w) of the principle axis of inertia of all of the bodies in their
        respective link frames. Shape is (num_instances, 1, 4).

        This quantity is the orientation of the principles axes of inertia relative to its body's link frame.
        """
        out = wp.zeros((self._root_view.count, self._root_view.link_count), dtype=wp.quatf, device=self.device)
        wp.launch(
            split_transform_batched_array_to_quaternion_batched_array,
            dim=(self._root_view.count, self._root_view.link_count),
            inputs=[
                self.body_com_pose_b,
                out,
            ],
        )
        return out

    ##
    # Properties for backwards compatibility.
    ##

    @property
    @deprecated("default_root_pose", "default_root_vel", since="3.0.0", remove_in="4.0.0")
    def default_root_state(self) -> wp.array(dtype=vec13f):
        """Same as :attr:`default_root_pose`."""
        state = wp.zeros((self._root_view.count), dtype=vec13f, device=self.device)
        wp.launch(
            combine_pose_and_velocity_to_state,
            dim=(self._root_view.count),
            device=self.device,
            inputs=[
                self._default_root_pose,
                self._default_root_vel,
                state,
            ],
        )
        return state

    @property
    @deprecated("root_pose_w", since="3.0.0", remove_in="4.0.0")
    def root_pose_w(self) -> wp.array(dtype=wp.transformf):
        """Same as :attr:`root_link_pose_w`."""
        return self.root_link_pose_w

    @property
    @deprecated("root_pos_w", since="3.0.0", remove_in="4.0.0")
    def root_pos_w(self) -> wp.array(dtype=wp.vec3f):
        """Same as :attr:`root_link_pos_w`."""
        return self.root_link_pos_w

    @property
    @deprecated("root_quat_w", since="3.0.0", remove_in="4.0.0")
    def root_quat_w(self) -> wp.array(dtype=wp.quatf):
        """Same as :attr:`root_link_quat_w`."""
        return self.root_link_quat_w

    @property
    @deprecated("root_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_vel_w(self) -> wp.array(dtype=wp.spatial_vectorf):
        """Same as :attr:`root_com_vel_w`."""
        return self.root_com_vel_w

    @property
    @deprecated("root_lin_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_lin_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Same as :attr:`root_com_lin_vel_w`."""
        return self.root_com_lin_vel_w

    @property
    @deprecated("root_com_ang_vel_w", since="3.0.0", remove_in="4.0.0")
    def root_ang_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Same as :attr:`root_com_ang_vel_w`."""
        return self.root_com_ang_vel_w

    @property
    @deprecated("root_com_lin_vel_b", since="3.0.0", remove_in="4.0.0")
    def root_lin_vel_b(self) -> wp.array(dtype=wp.vec3f):
        """Same as :attr:`root_com_lin_vel_b`."""
        return self.root_com_lin_vel_b

    @property
    @deprecated("root_com_ang_vel_b", since="3.0.0", remove_in="4.0.0")
    def root_ang_vel_b(self) -> wp.array(dtype=wp.vec3f):
        """Same as :attr:`root_com_ang_vel_b`."""
        return self.root_com_ang_vel_b

    @property
    @deprecated("body_link_pose_w", since="3.0.0", remove_in="4.0.0")
    def body_pose_w(self) -> wp.array(dtype=wp.transformf):
        """Same as :attr:`body_link_pose_w`."""
        return self.body_link_pose_w

    @property
    @deprecated("body_link_pos_w", since="3.0.0", remove_in="4.0.0")
    def body_pos_w(self) -> wp.array(dtype=wp.vec3f):
        """Same as :attr:`body_link_pos_w`."""
        return self.body_link_pos_w

    @property
    @deprecated("body_link_quat_w", since="3.0.0", remove_in="4.0.0")
    def body_quat_w(self) -> wp.array(dtype=wp.quatf):
        """Same as :attr:`body_link_quat_w`."""
        return self.body_link_quat_w

    @property
    @deprecated("body_com_vel_w", since="3.0.0", remove_in="4.0.0")
    def body_vel_w(self) -> wp.array(dtype=wp.spatial_vectorf):
        """Same as :attr:`body_com_vel_w`."""
        return self.body_com_vel_w

    @property
    @deprecated("body_com_lin_vel_w", since="3.0.0", remove_in="4.0.0")
    def body_lin_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Same as :attr:`body_com_lin_vel_w`."""
        return self.body_com_lin_vel_w

    @property
    @deprecated("body_com_ang_vel_w", since="3.0.0", remove_in="4.0.0")
    def body_ang_vel_w(self) -> wp.array(dtype=wp.vec3f):
        """Same as :attr:`body_com_ang_vel_w`."""
        return self.body_com_ang_vel_w

    @property
    @deprecated("body_com_acc_w", since="3.0.0", remove_in="4.0.0")
    def body_acc_w(self) -> wp.array(dtype=wp.spatial_vectorf):
        """Same as :attr:`body_com_acc_w`."""
        return self.body_com_acc_w

    @property
    @deprecated("body_com_lin_acc_w", since="3.0.0", remove_in="4.0.0")
    def body_lin_acc_w(self) -> wp.array(dtype=wp.vec3f):
        """Same as :attr:`body_com_lin_acc_w`."""
        return self.body_com_lin_acc_w

    @property
    @deprecated("body_com_ang_acc_w", since="3.0.0", remove_in="4.0.0")
    def body_ang_acc_w(self) -> wp.array(dtype=wp.vec3f):
        """Same as :attr:`body_com_ang_acc_w`."""
        return self.body_com_ang_acc_w

    @property
    @deprecated("body_com_pos_b", since="3.0.0", remove_in="4.0.0")
    def com_pos_b(self) -> wp.array(dtype=wp.vec3f):
        """Same as :attr:`body_com_pos_b`."""
        return self.body_com_pos_b

    @property
    @deprecated("body_com_quat_b", since="3.0.0", remove_in="4.0.0")
    def com_quat_b(self) -> wp.array(dtype=wp.quatf):
        """Same as :attr:`body_com_quat_b`."""
        return self.body_com_quat_b

    ###
    # Helper functions.
    ###

    def _create_simulation_bindings(self) -> None:
        """Create simulation bindings for the root data.

        Direct simulation bindings are pointers to the simulation data, their data is not copied, and should
        only be updated using warp kernels. Any modifications made to the bindings will be reflected in the simulation.
        Hence we encourage users to carefully think about the data they modify and in which order it should be updated.

        .. caution:: This is possible if and only if the properties that we access are strided from newton and not
        indexed. Newton willing this is the case all the time, but we should pay attention to this if things look off.
        """
        # -- root properties
        self._sim_bind_root_link_pose_w = self._root_view.get_root_transforms(NewtonManager.get_state_0())
        self._sim_bind_root_com_vel_w = self._root_view.get_root_velocities(NewtonManager.get_state_0())
        # -- body properties
        self._sim_bind_body_com_pos_b = self._root_view.get_attribute("body_com", NewtonManager.get_model())
        self._sim_bind_body_link_pose_w = self._root_view.get_link_transforms(NewtonManager.get_state_0())
        self._sim_bind_body_com_vel_w = self._root_view.get_link_velocities(NewtonManager.get_state_0())
        self._sim_bind_body_mass = self._root_view.get_attribute("body_mass", NewtonManager.get_model())
        self._sim_bind_body_inertia = self._root_view.get_attribute("body_inertia", NewtonManager.get_model())
        self._sim_bind_body_external_wrench = self._root_view.get_attribute("body_f", NewtonManager.get_state_0())

    def _create_buffers(self) -> None:
        """Create buffers for the root data."""

        # Short-hand for the number of instances, number of links, and number of joints.
        n_view = self._root_view.count
        n_link = self._root_view.link_count

        # MASKS
        self.ALL_ENV_MASK = wp.ones((n_view,), dtype=wp.bool, device=self.device)
        self.ALL_BODY_MASK = wp.ones((n_link,), dtype=wp.bool, device=self.device)
        self.ENV_MASK = wp.zeros((n_view,), dtype=wp.bool, device=self.device)
        self.BODY_MASK = wp.zeros((n_link,), dtype=wp.bool, device=self.device)

        # Initialize history for finite differencing. If the articulation is fixed, the root com velocity is not
        # available, so we use zeros.
        try:
            self._previous_root_com_vel = wp.clone(self._root_view.get_root_velocities(NewtonManager.get_state_0()))
        except Exception as e:
            logger.error(f"Error getting root com velocity: {e}. If the rigid object is fixed, this is expected.")
            self._previous_root_com_vel = wp.zeros((n_view, n_link), dtype=wp.spatial_vectorf, device=self.device)
        # -- default root pose and velocity
        self._default_root_pose = wp.zeros((n_view,), dtype=wp.transformf, device=self.device)
        self._default_root_vel = wp.zeros((n_view,), dtype=wp.spatial_vectorf, device=self.device)

        # Initialize history for finite differencing
        self._previous_body_com_vel = wp.clone(self._root_view.get_link_velocities(NewtonManager.get_state_0()))

        # Initialize the lazy buffers.
        # -- link frame w.r.t. world frame
        self._root_link_vel_w = TimestampedWarpBuffer(shape=(n_view,), dtype=wp.spatial_vectorf)
        self._root_link_vel_b = TimestampedWarpBuffer(shape=(n_view,), dtype=wp.spatial_vectorf)
        self._projected_gravity_b = TimestampedWarpBuffer(shape=(n_view,), dtype=wp.vec3f)
        self._heading_w = TimestampedWarpBuffer(shape=(n_view,), dtype=wp.float32)
        self._body_link_vel_w = TimestampedWarpBuffer(shape=(n_view, n_link), dtype=wp.spatial_vectorf)
        # -- com frame w.r.t. world frame
        self._root_com_pose_w = TimestampedWarpBuffer(shape=(n_view,), dtype=wp.transformf)
        self._root_com_vel_b = TimestampedWarpBuffer(shape=(n_view,), dtype=wp.spatial_vectorf)
        self._root_com_acc_w = TimestampedWarpBuffer(shape=(n_view,), dtype=wp.spatial_vectorf)
        self._body_com_pose_w = TimestampedWarpBuffer(shape=(n_view, n_link), dtype=wp.transformf)
        self._body_com_acc_w = TimestampedWarpBuffer(shape=(n_view, n_link), dtype=wp.spatial_vectorf)

    def update(self, dt: float):
        # update the simulation timestamp
        self._sim_timestamp += dt
        # Trigger an update of the joint and body acceleration buffers at a higher frequency since we do finite
        # differencing.
        self.body_com_acc_w
